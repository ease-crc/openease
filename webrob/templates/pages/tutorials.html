{% extends "pages/knowrob_base.html" %}

{% block head_inner %}
 <!-- <script type="text/javascript" src="{{ url_for('static', filename='openease.js') }}"></script>  -->
  
  <!-- <script type="text/javascript" src="{{ url_for('static', filename='lib/ros/JSONProlog.js') }}"></script>

  <script type="text/javascript" src="{{ url_for('static', filename='lib/chart/google-jsapi.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='lib/chart/DonutChart.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='lib/chart/BarChart.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='lib/chart/TreeDiagram.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='lib/chart/Timeline.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='lib/chart/DataVisClient.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='lib/chart/TaskTreeVisClient.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='lib/chart/array-nonstandard.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='lib/chart/Control.js') }}"></script>
  
  <script type="text/javascript" src="{{ url_for('static', filename='lib/utility.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='lib/console.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='lib/iframes/kb-frame.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='js/pages/teaching.js') }}"></script> -->

<script type="text/javascript" src="{{ url_for('static', filename='js/form-js/image_resizer.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/ROSCanvas.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/pages/QA.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/ROSCanvas.js') }}"></script>

<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/SCSS/split.css') }}" />



<style>

.query-font {
  font-size: 20px;
}

.smaller-screen-size {
  min-width: 320px; //smallest screen size
}

#page-content {
  -webkit-box-sizing: border-box;
  box-sizing: border-box;
  width:100%;
  height: -o-calc(100% - 108px); /* opera */
  height: -webkit-calc(100% - 108px); /* google, safari */
  height: -moz-calc(100% - 108px); /* firefox */
  height: calc(100% - 108px); /* firefox 53 and newer*/
}

#user_query {
  width:100%;
  height:100%;
  border-bottom: 1px solid #CCC;
  font-size: 20px;
}

#history {
  background: url("{{ url_for('static', filename='logos/ease-light.png') }}");
  background-repeat: no-repeat;
  background-position: center;
  background-size: 40%;
}

#markers {
  width: 100%;
  height: 100%;
  border: 1px solid #BBB;
  overflow: hidden;
}

</style>
{% endblock %}

{% block content %}
  <script type="text/javascript">
    var ui;
    var visClient, graphClient;
    var current_exercise_id = 0;

    function highlightElement(name, type, highlight) {
        if(typeof type == "string") {
            if(type === "class") {
              var elems = document.getElementsByClassName(name);
              for (i = 0; i < elems.length; i++) {
                elems[i].style.backgroundColor = highlight ? "#144F78" : "#BBB";
                elems[i].style.border = highlight ? "5px solid #144F78" : "1px solid #BBB";
              }
            }
            else if(type === "id") {
              document.getElementById(name).style.border = highlight ? "5px solid #144F78" : "1px solid #BBB";
            }
        }
    };
    
    debugger;
    
        ui =  new KnowrobUI(flask_user, {
            authentication: '{{ authentication }}',
            ros_url: 'ws' + (location.protocol === 'https:' ? 's' : '') +
                '://{{ host_url }}/ws/{{ container_name }}/'
        });
        
       $(document).ready(ui.init);
       
       $(document).ready(function(){          
           loadTutorial('overview', 1);
           resize();
       });
        //    if (parent.client.nodesRegistered && !visClient) {
        //        on_register_nodes();
        //    }
        
        
        
   


    
    function selectMarker(marker) {
        var prolog = parent.client.newProlog();
        prolog.jsonQuery("term_to_atom("+marker.ns+",MarkerName), "+
            "marker_queries(MarkerName, MarkerQueries).",
            function(result) {
                prolog.finishClient();
                ui.loadObjectQueries(result.solution.MarkerQueries);
            }
        );
    };
    function unselectMarker() {
        ui.initQueryLibrary();
    };
    function removeMarker(marker) {
        if(marker === parent.client.selectedMarker) {
            unselectMarker();
        }
    };
    
    function on_designator_received(obj) {
      $('#designator').html('');
      $('#designator').append(obj);
      $('#designator').change();
    };
    
    function on_image_received(imageHtml, imageWidth, imageHeight) {
        ui.imageWidth = imageWidth;
        ui.imageHeight = imageHeight;
        
        document.getElementById('mjpeg').innerHTML = imageHtml;
        $('#mjpeg').change();
        $('#mjpeg').resize();
    };
    
    function on_camera_pose_received(pose) {
        ui.setCameraPose(pose);
    };
    
    function on_register_nodes() {
        visClient = new DataVisClient({
            ros: parent.client.ros,
            containerId: '#chart',
            topic: 'data_vis_msgs'
        });
    };
    
    function resizeImage() {
        return imageResizer($('#mjpeg_image'), $('#mjpeg'),
            imageWidth($('#mjpeg_image'))[0],
            imageHeight($('#mjpeg_image'))[0]);
    };

    function resize() {
        var pageLayout = $('#page-content').layout({
            stateManagement__enabled: true,
            south: { minSize: 60 },
            west: {
                minSize: 250,
                size: 500,
                // INNER-LAYOUT
                childOptions: {
                    center: { paneSelector: "#markers", minSize: 250,
                      onresize: function() { ui.resizeCanvas(); } },
                    south: {
                        paneSelector: "#console",
                        onresize: function() {
                            ace.edit("history").resize(true);
                            ace.edit("user_query").resize(true);
                        },
                        minSize: 150
                    }
                }
            },
            center: {},
            east: {
                minSize: 250,
                size: 500,
                // INNER-LAYOUT
                childOptions: {
                    center: { paneSelector: "#designator", minSize: 250 },
                    south: { paneSelector: "#mjpeg", minSize: 150 }
                }
            }
        });
        centerLayout = $('#editor-container').layout({
            center: { paneSelector: "#library", minSize: 250 },
            south: { paneSelector: "#chart", initClosed: true, minSize: 50 }
        });
//         FIXME open undefined?
//         pageLayout.open('east');
//         pageLayout.open('west');
//         centerLayout.open('south');
//         
//         ui.resizeCanvas();
//         
//         $('#designator').change(function() { pageLayout.open('east'); });
//         $('#mjpeg').change(function() { pageLayout.open('east'); });
//         $('#chart').change(function() { centerLayout.open('south'); });
        $('#mjpeg').resize(function(){
            var timeout = function(){ if(resizeImage()) window.setTimeout(timeout, 10); };
            if(resizeImage()) window.setTimeout(timeout, 10);
        });
    };
    
    function loadTutorial(category, page) {
        $.ajax({
            url: "/tutorials/get",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ page: page}),  
            dataType: "json"
        }).done( function (data) {
            var lib = document.getElementById('library');
            lib.innerHTML = ''; // clear
            // <h2>tut.cat_title</h2>
            var h2 = document.createElement("h2");
            h2.innerHTML = data.this.cat_id;
            lib.appendChild(h2);
            // <h4>tut.page.  tut.title</h4>
            var h4 = document.createElement("h4");
            h4.innerHTML = data.this.page + '. ' + data.this.title;
            lib.appendChild(h4);
            // {{ content }}
            var text = document.createElement("div");
            text.innerHTML = data.this.text;
            lib.appendChild(text);
            // <div id="tut_nav">
            var nav = document.createElement("div");
            nav.id = 'tut_nav';
            if(data.prev) {
                // <div style="float:left;">
                //    <a onclick="loadTutorial(prev.cat_id, prev.page)">Previous: prev.title</a>
                // </div>
                var link = document.createElement("div");
                var link_a = document.createElement("a");
                link.style.float = 'left';
                link_a.innerHTML = 'Previous: ' + data.prev.title
                link_a.onclick = function() { loadTutorial(data.prev.cat_id, data.prev.page); };
                link.appendChild(link_a);
                nav.appendChild(link);
            }
            // <div style="float:right;">
            //    <a onclick="loadTutorial(nxt.cat_id, nxt.page)">Next: nxt.title</a>
            // </div>
            var link = document.createElement("div");
            var link_a = document.createElement("a");
            link.style.float = 'right';
            if(data.next) {
                link_a.innerHTML = 'Next: ' + data.next.title
                link_a.onclick = function() { loadTutorial(data.next.cat_id, data.next.page); };
            } else {
                link_a.innerHTML = 'Tutorial Overview'
                link_a.onclick = function() { loadTutorial('overview', 1); };
            }
            link.appendChild(link_a);
            nav.appendChild(link);
            
            lib.appendChild(nav);
            
            // hook for links of class "show_code" that pastes the content of the
            // previous code block into the query field
            $( "a.show_code" ).click(function( event ) {
                var query_text = $(this).closest("pre + *").prev().find('code').html();
                $("#user_query").replaceWith(query_text);
                event.preventDefault();
            });
        });
    };
    
    function highlightElement(name, type, highlight) {
      if(typeof type == "string") {
        var highlighter = $('#dom-highlight');
        var element = undefined;
        if(type === "class") {
            element = $('.'+name);
        }
        else if(type === "id") {
            element = $('#'+name);
        }
        if(highlight && element) {
            highlighter.css('display', 'block');
            highlighter.css('width',  element.width());
            highlighter.css('height', element.height());
            highlighter.css('top',    element.offset().top);
            highlighter.css('left',   element.offset().left);
            element.change();
        }
        else {
            highlighter.css('display', 'none');
        }
      }
    }; 
  </script>

<div id="page-content">
    <div class="ui-layout-center" id="editor-container">
        <div id="library" class="black_border tutorial-library"></div>
        <div id="QA-container" class="w-100 split split-horizontal">
            <div id="vis-container" class="split w-100">
                <div id="history"></div>
                <div id="markers"></div>
            </div>
        
            <div id="console" class="container-fluid p-0 split split-content">
                <div class="h-100 d-flex flex-column">
                    <div id="user_query" class="flex-grow-1 smaller-screen-size">member(A, [a,b,c]).</div>
                    <div class="btn-toolbar justify-content-between" role="toolbar" aria-label="Toolbar with button groups">
                        <div class="btn-group">
                            <div class="btn-group">
                                <button id="query-examples" type="button" class="btn btn-light dropdown-toggle"
                                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Examples</button>
                                <div class="dropdown-menu" aria-labelledby="query-examples">
                                    <!-- TODO: store example queries in some text file. -->
                                    <!-- TODO: include NEEM example queries here? -->
                                    <!-- TODO: include contextual queries here? (e.g. about selected object etc.) -->
                                    <h5 class="dropdown-header">Charts</h5>
                                    <a class="dropdown-item" href="#"
                                        onclick="page.console.query('data_vis(piechart(chart_id), [\n    title: some_distribution,\n    data: [[a,b,c],[10,30,22]]]).')">Pie
                                        Chart</a>
                                    <a class="dropdown-item" href="#"
                                        onclick="page.console.query('data_vis(barchart(chart_id), [\n    title: some_distribution,\n    data: [[a,b,c],[10,30,22]]]).')">Bar
                                        Chart</a>
                                    <a class="dropdown-item" href="#"
                                        onclick="page.console.query('data_vis(timeline(chart_id), [\n    title: some_distribution,\n    data: [[a,b,c],[\'0_10\',\'5_15\',\'0_20\']]]).')">Timeline</a>
                                </div>
                            </div>
                            <div class="btn-group">
                                <button id="query-view" type="button" class="btn btn-light dropdown-toggle"
                                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">View</button>
                                <div class="dropdown-menu" aria-labelledby="query-view">
                                    <a class="dropdown-item" href="#" onclick="page.console.zoomIn()"><i
                                            class="fas fa-plus"></i> Larger Text</a>
                                    <a class="dropdown-item" href="#" onclick="page.console.zoomOut()"><i
                                            class="fas fa-minus"></i> Smaller Text</a>
                                </div>
                            </div>
                        </div>
                        <div class="btn-group" role="group" aria-label="Third group">
                            <button id="btn_query" type="button" class="btn btn-primary" onclick="page.console.query()"><i
                                    class="fas fa-question"></i></button>
                            <button id="btn_query_next" type="button" class="btn btn-primary"
                                onclick="page.console.nextSolution()"><i class="fas fa-redo"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- <div id="tutorial_page" class="split w-100">
        <div id="tutorial" class="split split-horizontal split-content h-100 smaller-screen-size">
            <p>{{ tutorial_md }}</p>
        </div>
        <div id="tutorial_query" class="split split-horizontal split-content h-100 smaller-screen-size">
            <h2>Column 2</h2>
            <p id="load_query">Some text.. testing </p>
        </div>
    </div> -->

    <div class="ui-layout-east">
        <div id="designator">
            This pane enables the user to inspect the internal data structures of the robot's beliefs
            including object, action, and location descriptions used by the robot.
        </div>
        <div id="mjpeg">
            This pane is used for displaying images captured by the robot's camera.
            It's also possible to play videos in this pane (captured during task execution or generated
            by openEASE episode replay).
        </div>
    </div>
</div>
<!-- <div id="page-content">
    <div class="ui-layout-center" id="editor-container">
        <div id="library" class="black_border tutorial-library">
        </div>
        <div id="chart">
This pane can visualize statistical data using different chart types.
        </div>	
    </div>

    <div class="ui-layout-west">
        <div id="markers"></div>
        <div id="console">
            <div id="console_top">
                <div class="console_text" id="history" style="font-size:20px;"></div>
                <div class="console_text" id="user_query" style="font-size:20px;"></div>
            </div>
            <div id="console_bottom">
                <div id="query_buttons">
                    <ul class="query_button_group">
                        <li><a href="#" class="query_button icon_question" id="btn_query" onclick="ui.console.query()" title="Ask a query"></a></li>
                        <li><a href="#" class="query_button icon_redo" id="btn_query_next" onclick="ui.console.nextSolution()" title="Infer next solution"></a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
        
    <div class="ui-layout-east">
        <div id="designator">
This pane enables the user to inspect the internal data structures of the robot's beliefs
including object, action, and location descriptions used by the robot.
        </div>
        <div id="mjpeg">
This pane is used for displaying images captured by the robot's camera.
It's also possible to play videos in this pane (captured during task execution or generated
by openEASE episode replay).
        </div>
    </div> -->
    
    <div id="dom-highlight">
</div>
  
{% endblock %}

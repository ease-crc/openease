{% extends "layout.html" %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='lib/kendo/kendo.common.min.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='lib/kendo/kendo.default.min.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='lib/kendo/kendo.dataviz.min.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='lib/kendo/kendo.dataviz.default.min.css') }}" />
    <script type="text/javascript"  src="{{ url_for('static', filename='lib/kendo/kendo.all.min.js') }}" ></script>
{% endblock %}

{% block content %}
    <script id="create_template" type="text/x-kendo-template">
        <a class="k-button" href="\#" onclick="return new_experiment()">Create new experiment</a>
    </script>
    <script>
    function new_experiment() {
        var cat = prompt("Please enter a category", 'Pick-and-Place');
        if(!cat) return;
        var n = prompt("Please enter a name", 'exp_0');
        if(!n) return;
        
        $.ajax({
            url: '/knowrob/exp_new/'+cat+'/'+n,
            type: "POST",
            contentType: "application/json",
            dataType: "json",
            success: function (data) {
                console.log("Experiment created!");
                $('#grid').data('kendoGrid').dataSource.read();
                $('#grid').data('kendoGrid').refresh();
            }
        }).done( function (request) {});
    };
    function moveExperiment(e) {
        e.preventDefault();
        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        var cat = prompt("Please enter a category", dataItem.cat);
        if(!cat) return;
        var n = prompt("Please enter a name", dataItem.exp);
        if(!n) return;
        $.ajax({
            url: '/knowrob/exp_move/'+dataItem.cat+'/'+dataItem.exp,
            type: "POST",
            contentType: "application/json",
            dataType: "json",
            data: JSON.stringify({ cat: cat, exp: n }),
            success: function (data) {
                $('#grid').data('kendoGrid').dataSource.read();
                $('#grid').data('kendoGrid').refresh();
            }
        });
    };
    function projectsEditor(container, options) {
        $("<select multiple='multiple' data-bind='value : projects'/>").appendTo(container).kendoMultiSelect({
            dataTextField: "name",
            dataValueField: "name",
            dataSource: {
                transport: {
                    read: {
                        url: "/db/find/project",
                        dataType: "json",
                        type: "POST",
                        contentType: "application/json"
                    },
                },
                schema: {
                    data: 'result',
                    model: {
                        id: "id",
                        fields: {
                            name: { type: "string" }
                        }
                    }
                }
            }
        });
    };
    function tagsEditor(container, options) {
        $("<select multiple='multiple' data-bind='value : tags'/>").appendTo(container).kendoMultiSelect({
            dataTextField: "name",
            dataValueField: "name",
            dataSource: {
                transport: {
                    read: {
                        url: "/db/find/tag",
                        dataType: "json",
                        type: "POST",
                        contentType: "application/json"
                    },
                },
                schema: {
                    data: 'result',
                    model: {
                        id: "id",
                        fields: {
                            name: { type: "string" }
                        }
                    }
                }
            }
        });
    };
    function platformsEditor(container, options) {
        $("<select multiple='multiple' data-bind='value : platforms'/>").appendTo(container).kendoMultiSelect({
            dataTextField: "name",
            dataValueField: "name",
            dataSource: {
                transport: {
                    read: {
                        url: "/db/find/platform",
                        dataType: "json",
                        type: "POST",
                        contentType: "application/json"
                    },
                },
                schema: {
                    data: 'result',
                    model: {
                        id: "id",
                        fields: {
                            name: { type: "string" }
                        }
                    }
                }
            }
        });
    };
    function projectsDisplay(data) {
        var res = [];
        $.each(data.projects, function (idx, elem) { res.push(elem.name); });
        return res.join(", ");
    };
    function tagsDisplay(data) {
        var res = [];
        $.each(data.tags, function (idx, elem) { res.push(elem.name); });
        return res.join(", ");
    };
    function platformsDisplay(data) {
        var res = [];
        $.each(data.platforms, function (idx, elem) { res.push(elem.name); });
        return res.join(", ");
    };
    $(document).ready(function () {
        $("#grid").kendoGrid({
            dataSource: {
                transport: {
                    read: {
                        url: "/knowrob/exp_meta_data",
                        dataType: "json",
                        type: "POST",
                        contentType: "application/json"
                    },
                },
                batch: true,
                schema: {
                    data: 'experiments',
                    model: {
                        id: "id",
                        fields: {
                            cat: { editable: false, nullable: false },
                            exp: { editable: false, nullable: false },
                            name: { editable: true, nullable: false },
                            description: { editable: true, nullable: true },
                            projects: { editable: true, nullable: true },
                            tags: { editable: true, nullable: true },
                            platforms: { editable: true, nullable: true }
                        }
                    }
                }
            },
            columns: [
                { field: "cat", title: "Category", width: "60px" },
                { field: "exp", title: "Experiment", width: "60px" },
                { field: "name", title: "Name", width: "100px" },
                { field: "description", title: "Description", width: "150px" },
                { field: "projects", title: "Projects", width: "70px", template: projectsDisplay, editor: projectsEditor },
                { field: "tags", title: "IEEE Tags", width: "70px", template: tagsDisplay, editor: tagsEditor },
                { field: "platforms", title: "Platforms", width: "70px", template: platformsDisplay, editor: platformsEditor },
                { command: ["edit", { text: "Move", click: moveExperiment }], title: "&nbsp;" , width: "50px" }
            ],
            toolbar: [
                { template: kendo.template($("#create_template").html()) }
            ],
            save: function(e) {
                $.ajax({
                    url: "/knowrob/exp_save/"+e.model.cat+"/"+e.model.exp,
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ meta: {
                        name: e.model.name,
                        description: e.model.description,
                        projects: e.model.projects.map(function(x) {return x.name;}),
                        tags: e.model.tags.map(function(x) {return x.name;}),
                        platforms: e.model.platforms.map(function(x) {return x.name;})
                    }}),  
                    dataType: "json",
                    success: function (data) {
                        $('#grid').data('kendoGrid').dataSource.read();
                        $('#grid').data('kendoGrid').refresh();
                    }
                }).done( function (request) {});
            },
            cancel:function(e) {
                $('#grid').data('kendoGrid').dataSource.read();
                $('#grid').data('kendoGrid').refresh();
            },
            selectable: true,
            editable: "popup",
            sortable: true
        });
    });
</script>
<div id="exp_admin_panel">
    <div id="grid"> </div>
</div>
{% endblock %}